{% extends 'main/base.html' %}
{% load static %}

{% block title %}All Offers | Sportify{% endblock %}

{% block content %}
<div class="container mt-5" style="max-width: 900px;">
    <h2 class="mb-4 fw-bold">All Offers</h2>
<div class="text-start ">
    {% if user.is_authenticated and user.club %}
        <div class="d-flex justify-content-start gap-3 p-3">
            <a href="{% url 'offers:add_offer' %}" class="btn btn-dark px-4">Add a new add!</a>
            <a href="{% url 'subscriptions:plus_plan' %}" class="btn btn-dark px-4">UPGRADE</a>
        </div>
    {% endif %}
</div>
<hr>

    <div id="offers-container">
        {% for offer in offers %}
        <div class="card mb-3 shadow-sm p-2 d-flex flex-row align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-3">
                <img src="#" alt="Profile" width="40" height="40" class="rounded-circle">
                <div>
                    <h6 class="mb-0">{{ offer.title }}</h6>
                </div>
            </div>
            <a href="{% url 'offers:offer_details' offer.id %}" class="btn btn-dark btn-sm">apply</a>
        </div>
        {% empty %}
        <div class="alert alert-info text-center">No offers yet.</div>
        {% endfor %}
    </div>

    <!-- Spinner while loading -->
    <div id="loading-spinner" class="text-center my-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>


</div>

<script>
    let currentPage = 1;
    const offersContainer = document.getElementById('offers-container');
    const loadingSpinner = document.getElementById('loading-spinner');

    const loadMoreOffers = () => {
        currentPage++;
        loadingSpinner.style.display = 'block';

        fetch(`?page=${currentPage}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            loadingSpinner.style.display = 'none';
            data.offers.forEach(offer => {
                const offerHTML = `
                    <div class="card mb-3 shadow-sm p-2 d-flex flex-row align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-3">
                            <img src="/static/images/default_profile.png" alt="Profile" width="40" height="40" class="rounded-circle">
                            <div>
                                <h6 class="mb-0">${offer.title}</h6>
                            </div>
                        </div>
                        <a href="/offers/offer/${offer.id}/" class="btn btn-dark btn-sm">apply</a>
                    </div>
                `;
                offersContainer.insertAdjacentHTML('beforeend', offerHTML);
            });
        })
        .catch(error => {
            console.error('Error loading offers:', error);
        });
    };

    window.addEventListener('scroll', () => {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
            loadMoreOffers();
        }
    });
</script>
{% endblock %}
