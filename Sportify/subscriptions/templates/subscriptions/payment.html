{% extends 'main/base.html' %}

{% block title %}Payment | Sportify{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center">Complete Your Payment</h1>
    <p class="text-center">Pay 0.99 SAR to subscribe to the Plus Plan.</p>

    <form id="payment-form" method="post">
        {% csrf_token %}
        <div id="card-element" class="form-control mb-3"></div>
        <button id="submit" class="btn btn-primary w-100">Pay 0.99 SAR</button>
    </form>

    <div id="payment-message" class="mt-3 text-center"></div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ stripe_publishable_key }}');
    const elements = stripe.elements();
    const cardElement = elements.create('card');
    cardElement.mount('#card-element');

    const form = document.getElementById('payment-form');
    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const { paymentMethod, error } = await stripe.createPaymentMethod({
            type: 'card',
            card: cardElement,
        });

        if (error) {
            document.getElementById('payment-message').textContent = error.message;
        } else {
            const response = await fetch('', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({ payment_method_id: paymentMethod.id }),
            });

            const result = await response.json();
            if (result.error) {
                document.getElementById('payment-message').textContent = result.error;
            } else {
                window.location.href = '/subscriptions/payment_success/';
            }
        }
    });
</script>
{% endblock %}