{% extends "main/base.html" %}
{% load custom_filters %}
{% load static %}

{% block content %}
<div class="container my-4">
  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
  
  <div class="row">
    <!-- Left Sidebar: User List and Search -->
    <div class="col-md-4">
      <form method="get" class="mb-3">
        <input type="text" name="q" class="form-control" placeholder="Search users..." value="{{ search_query }}">
      </form>

      <ul class="list-group">
        {% for user in users %}
        <a href="{% url 'direct_message:chat_page' username=user.username %}" class="list-group-item list-group-item-action d-flex align-items-center {% if selected_user and user == selected_user %}active{% endif %}">
          {% if user.athlete and user.athlete.profilePhoto %}
            <img src="{{ user.athlete.profilePhoto.url }}" class="rounded-circle me-2" style="width: 35px; height: 35px; object-fit: cover;">
          {% elif user.club and user.club.photo %}
            <img src="{{ user.club.photo.url }}" class="rounded-circle me-2" style="width: 35px; height: 35px; object-fit: cover;">
          {% else %}
            <img src="{% static 'images/profile.png' %}" class="rounded-circle me-2" style="width: 35px; height: 35px; object-fit: cover;">
          {% endif %}

          <div class="d-flex justify-content-between w-100 align-items-center">
            <span>{{ user.username }}</span>
            {% if unread_counts|get_item:user.id %}
              <span class="badge bg-danger ms-2">{{ unread_counts|get_item:user.id }}</span>
            {% endif %}
          </div>
        </a>
        {% endfor %}
      </ul>
    </div>

    <!-- Right Panel: Chat -->
    <div class="col-md-8">
      {% if selected_user %}
      <div class="chat-box border rounded p-3 mb-3" style="height: 400px; overflow-y: scroll;">
        {% regroup chat_messages by timestamp.date as date_groups %}
        {% for group in date_groups %}
          <div class="text-center text-muted my-3">
            <strong>{{ group.grouper|date:"F j" }}</strong>
          </div>
          {% for message in group.list %}
          {% if message.sender != request.user %}
          <!-- Sender (not current user) - align left -->
          <div class="d-flex align-items-start mb-3">
            <!-- Profile image on left -->
            <div class="me-2">
              {% if message.sender.athlete and message.sender.athlete.profilePhoto %}
                <img src="{{ message.sender.athlete.profilePhoto.url }}" alt="Profile Photo"
                     class="rounded-circle" style="width: 35px; height: 35px; object-fit: cover;">
              {% elif message.sender.club and message.sender.club.photo %}
                <img src="{{ message.sender.club.photo.url }}" alt="Profile Photo"
                     class="rounded-circle" style="width: 35px; height: 35px; object-fit: cover;">
              {% else %}
                <img src="{% static 'images/profile.png' %}" alt="Default Profile Photo"
                     class="rounded-circle" style="width: 35px; height: 35px; object-fit: cover;">
              {% endif %}
            </div>
            <!-- Message content -->
            <div style="max-width: 75%;">
              <div class="bg-light p-2 rounded">
                <p class="mb-1">{{ message.content }}</p>
                <small class="text-muted">{{ message.timestamp|date:"H:i" }}</small>
              </div>
            </div>
          </div>
          {% else %}
          <!-- Current user's message - align right -->
          <div class="d-flex align-items-start justify-content-end mb-3">
            <div style="max-width: 75%;">
              <div class="bg-primary text-white p-2 rounded">
                <p class="mb-1">{{ message.content }}</p>
                <small class="text-light">{{ message.timestamp|date:"H:i" }}</small>
              </div>
            </div>
            <div class="ms-2">
              {% if message.sender.athlete and message.sender.athlete.profilePhoto %}
                <img src="{{ message.sender.athlete.profilePhoto.url }}" alt="Profile Photo"
                     class="rounded-circle" style="width: 35px; height: 35px; object-fit: cover;">
              {% elif message.sender.club and message.sender.club.photo %}
                <img src="{{ message.sender.club.photo.url }}" alt="Profile Photo"
                     class="rounded-circle" style="width: 35px; height: 35px; object-fit: cover;">
              {% else %}
                <img src="{% static 'images/profile.png' %}" alt="Default Profile Photo"
                     class="rounded-circle" style="width: 35px; height: 35px; object-fit: cover;">
              {% endif %}
            </div>
          </div>
          {% endif %}
          {% endfor %}
        {% endfor %}
      </div>

      <form method="post" action="{% url 'direct_message:clear_conversation' selected_user.username %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm btn-outline-warning">Clear Conversation</button>
      </form>
      
      <!-- Send Message -->
      <form method="POST" class="mt-3">
        {% csrf_token %}
        <div class="input-group">
          <textarea name="content" rows="2" class="form-control" placeholder="Type a message..."></textarea>
          <button class="btn btn-primary" type="submit">Send</button>
        </div>
      </form>

      {% else %}
      <div class="text-muted">Select a user to start chatting.</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
