{% extends "main/base.html" %}
{% load static %}
{% block content %}

<div class="container mt-4">
  <div class="row">

    <!-- LEFT: Users with chat history + search -->
    <div class="col-md-4">
      <h4>Inbox</h4>

      <!-- Search bar -->
      <form method="get" class="mb-3">
        <input type="text" name="q" placeholder="Search users..." value="{{ search_query }}" class="form-control">
      </form>

      <!-- User list -->
      <ul class="list-group">
        {% for user in users %}
          <a href="{% url 'direct_message:chat_page' user.username %}" 
             class="list-group-item list-group-item-action {% if selected_user == user %}active{% endif %}">
            {{ user.username }}
          </a>
        {% empty %}
          <li class="list-group-item text-muted">No conversations yet.</li>
        {% endfor %}
      </ul>
    </div>

    <!-- RIGHT: Chat box -->
    <div class="col-md-8">
      {% if selected_user %}
        <h4 class="mb-3">Chat with {{ selected_user.username }}</h4>

        <div class="chat-box border rounded p-3 mb-3" style="height: 400px; overflow-y: scroll;">
          {% regroup chat_messages by timestamp.date as date_groups %}
        
          {% for day in date_groups %}
            <div class="text-center text-muted my-3">
              <strong>{{ day.grouper|date:"F j" }}</strong>
            </div>
        
            {% for message in day.list %}
              <div class="mb-2 {% if message.sender == request.user %}text-end{% endif %}">
                <strong>{{ message.sender.username }}:</strong> {{ message.content }}<br>
                <small class="text-muted">{{ message.timestamp|date:"H:i" }}</small>
              </div>
            {% endfor %}
          {% endfor %}
        </div>        

        <!-- Message form -->
        <form method="POST">
          {% csrf_token %}
          <textarea name="content" rows="2" class="form-control" placeholder="Type a message..."></textarea>
          <button class="btn btn-primary mt-2">Send</button>
        </form>
      {% else %}
        <div class="text-muted mt-5 text-center">
          <h5>Select a conversation or search to start a new one.</h5>
        </div>
      {% endif %}
    </div>

  </div>
</div>

{% endblock %}
