{% for post in posts %}
<div class="card mb-3 shadow-sm p-3 position-relative">
    <a href="{% url 'posts:post_details' post.id %}" class="stretched-link text-decoration-none text-dark"></a>

    <div class="d-flex justify-content-between align-items-start">
        <div class="d-flex align-items-center">
            <img src="#" alt="Profile" class="rounded-circle me-2" width="40" height="40">
            <div>
                <strong>
                    {% if post.user.athlete %}
                        {{ post.user.first_name }}
                    {% elif post.user.club %}
                        {{ post.user.club.clubName }} <i class="bi bi-patch-check-fill"></i>
                    {% else %}
                        {{ post.user.username }}
                    {% endif %}
                </strong><br>
                <small class="text-muted">@{{ post.user.username }}</small>
            </div>
        </div>

        <div class="d-flex gap-3 z-1">
            <!-- Bookmark/Unbookmark -->
            <form action="{% url 'bookmarks:bookmark_post' post.id %}" method="POST" class="bookmark-form d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm border-0 bg-transparent p-0 bookmark-btn" data-post-id="{{ post.id }}">
                    {% if post.is_bookmarked %}
                        <i class="bi bi-bookmark-fill" style="font-size: 1.2rem;"></i>
                    {% else %}
                        <i class="bi bi-bookmark" style="font-size: 1.2rem;"></i>
                    {% endif %}
                </button>
            </form>

            <!-- Like/Unlike -->
            <form action="{% url 'posts:like_post' post.id %}" method="POST" class="like-form d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm border-0 bg-transparent p-0 like-btn" data-post-id="{{ post.id }}">
                    {% if post.is_liked %}
                        <i class="bi bi-heart-fill" style="font-size: 1.3rem;"></i> <span class="like-count">{{ post.total_likes }}</span>
                    {% else %}
                        <i class="bi bi-heart" style="font-size: 1.3rem;"></i> <span class="like-count">{{ post.total_likes }}</span>
                    {% endif %}
                </button>
            </form>
        </div>
    </div>

    <div class="mt-3 z-1">
        <p>&nbsp;&nbsp;&nbsp;{{ post.content|truncatewords:25 }}</p>

        {% if post.photo %}
            <div class="mt-2">
                <img src="{{ post.photo.url }}" alt="Post Media" class="img-fluid rounded" style="max-height: 200px; width: auto; display: block; margin: 0 auto;">
            </div>
        {% endif %}
        {% if post.video %}
            <div class="mt-2">
                <video controls style="max-height: 200px; width: auto; display: block; margin: 0 auto;">
                    <source src="{{ post.video.url }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
        {% endif %}
    </div>

    <div class="text-end mt-3">
        {{ post.comments.count }} <i class="bi bi-chat" style="font-size: 1.3rem;"></i>
    </div>
</div>
{% endfor %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Handle Like/Unlike
  document.querySelectorAll('.like-form').forEach(form => {
    form.addEventListener('submit', event => {
      event.preventDefault(); // Prevent form submission
      const button = form.querySelector('.like-btn');
      const postId = button.dataset.postId;

      console.log(`Liking/Unliking post with ID: ${postId}`); // Debugging log

      fetch(form.action, {
        method: 'POST',
        headers: {
          'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
        },
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          console.log(`Successfully processed like/unlike for post ID: ${postId}`); // Debugging log
          return response.text(); // Expecting a redirect response
        })
        .then(() => {
          // Toggle the like icon and update the like count
          const likeCount = button.querySelector('.like-count');
          const icon = button.querySelector('i');
          const isLiked = icon.classList.contains('bi-heart-fill');

          if (isLiked) {
            icon.classList.remove('bi-heart-fill', 'text-danger');
            icon.classList.add('bi-heart');
            likeCount.textContent = parseInt(likeCount.textContent) - 1;
          } else {
            icon.classList.remove('bi-heart');
            icon.classList.add('bi-heart-fill', 'text-danger');
            likeCount.textContent = parseInt(likeCount.textContent) + 1;
          }
        })
        .catch(error => {
          console.error('Error processing like/unlike:', error);
        });
    });
  });

  // Handle Bookmark/Unbookmark
  document.querySelectorAll('.bookmark-form').forEach(form => {
    form.addEventListener('submit', event => {
      event.preventDefault(); // Prevent form submission
      const button = form.querySelector('.bookmark-btn');
      const postId = button.dataset.postId;

      console.log(`Bookmarking/Unbookmarking post with ID: ${postId}`); // Debugging log

      fetch(form.action, {
        method: 'POST',
        headers: {
          'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
        },
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          console.log(`Successfully processed bookmark/unbookmark for post ID: ${postId}`); // Debugging log
          return response.text(); // Expecting a redirect response
        })
        .then(() => {
          // Toggle the bookmark icon
          const icon = button.querySelector('i');
          const isBookmarked = icon.classList.contains('bi-bookmark-fill');

          if (isBookmarked) {
            icon.classList.remove('bi-bookmark-fill');
            icon.classList.add('bi-bookmark');
          } else {
            icon.classList.remove('bi-bookmark');
            icon.classList.add('bi-bookmark-fill');
          }
        })
        .catch(error => {
          console.error('Error processing bookmark/unbookmark:', error);
        });
    });
  });
});
</script>
